#SPDX-License-Identifier: MIT-0
---
# tasks file for roles/debian_hardening

- name: Ensure OpenSSH server is installed
  ansible.builtin.apt:
    name: openssh-server
    state: present
    update_cache: true
  tags: [ssh, hardening]

- name: Ensure sshd directory exists
  ansible.builtin.file:
    path: /etc/ssh/sshd_config.d
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: [ssh, hardening]

- name: Deploy SSH hardening configuration (templated)
  ansible.builtin.template:
    src: hardening_ssh.conf.j2
    dest: /etc/ssh/sshd_config.d/10-hardening.conf
    owner: root
    group: root
    mode: "0644"
  notify: Restart sshd
  tags: [ssh, hardening]

- name: Validate sshd configuration
  ansible.builtin.command: /usr/sbin/sshd -t -f /etc/ssh/sshd_config
  register: sshd_check
  changed_when: false
  failed_when: sshd_check.rc != 0
  tags: [ssh, hardening]

- name: Install security apt tools
  ansible.builtin.apt:
    name:
      - unattended-upgrades
      - apt-transport-https
      - apt-utils
    state: present
    update_cache: true
  tags: [updates, hardening]

- name: Deploy static unattended-upgrades config
  ansible.builtin.copy:
    src: security_unattended_upgrades.conf
    dest: /etc/apt/apt.conf.d/51security-unattended-upgrades
    owner: root
    group: root
    mode: "0644"
  tags: [updates, hardening]

- name: Ensure systemd directory exists for apt-daily-upgrade.timer
  ansible.builtin.file:
    path: /etc/systemd/system/apt-daily-upgrade.timer.d
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: [updates, hardening]

- name: Deploy systemd timer override for weekly security-only upgrades
  ansible.builtin.copy:
    src: apt-daily-upgrade.timer.override
    dest: /etc/systemd/system/apt-daily-upgrade.timer.d/override.conf
    owner: root
    group: root
    mode: "0644"
  notify: Reload systemd
  tags: [updates, hardening]

- name: Enable and start apt-daily-upgrade.timer (weekly schedule)
  ansible.builtin.systemd:
    name: apt-daily-upgrade.timer
    enabled: true
    state: started
    daemon_reload: true
  tags: [updates, hardening]

- name: Optionally disable daily apt index refresh (apt-daily.timer)
  ansible.builtin.systemd:
    name: apt-daily.timer
    enabled: false
    state: stopped
    masked: true
  when: hardening_disable_apt_daily_index_timer | default(true)
  tags: [updates, hardening]

- name: Enforce permissions on sensitive system files
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "/etc/passwd",  owner: "root", group: "root",   mode: "0644" }
    - { path: "/etc/group",   owner: "root", group: "root",   mode: "0644" }
    - { path: "/etc/shadow",  owner: "root", group: "shadow", mode: "0640" }
    - { path: "/etc/gshadow", owner: "root", group: "shadow", mode: "0640" }
    - { path: "/etc/ssh/sshd_config", owner: "root", group: "root", mode: "0644" }
  tags: [files, hardening]

- name: Ensure sticky bit on world-writable temp dirs
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "1777"
  loop:
    - /tmp
    - /var/tmp
  tags: [files, hardening]

- name: Apply sysctl hardening
  ansible.builtin.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: true
  loop:
    - { name: "fs.suid_dumpable",          value: "0" }
    - { name: "kernel.randomize_va_space", value: "2" }
    - { name: "fs.protected_symlinks",     value: "1" }
    - { name: "fs.protected_hardlinks",    value: "1" }
    - { name: "kernel.kptr_restrict",      value: "2" }
    - { name: "kernel.sysrq",              value: "0" }
  tags: [sysctl, hardening]

- name: Disable unnecessary services (if any provided)
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: false
    state: stopped
    masked: true
  loop: "{{ hardening_disable_services | default([]) }}"
  when: hardening_disable_services | default([]) | length > 0
  tags: [services, hardening]

