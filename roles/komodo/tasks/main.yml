#SPDX-License-Identifier: MIT-0
---
# tasks file for roles/komodo

- name: Ensure Komodo compose directory exists
  ansible.builtin.file:
    path: "{{ komodo_deployment_directory }}"
    state: directory
    mode: "0755"

- name: Ensure Komodo data directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0750"
  loop:
    - "{{ KOMODO_BACKUPS_PATH }}"
    - "{{ KOMODO_SYNCS_PATH }}"
    - "{{ PERIPHERY_PATH }}"
  loop_control:
    label: "{{ item }}"
  when: item is not none and item | length > 0

- name: Render Komodo docker compose file
  ansible.builtin.template:
    src: compose.yaml.j2
    dest: "{{ komodo_deployment_directory }}/compose.yaml"
    mode: "0644"

- name: Ensure Komodo stack is running
  community.docker.docker_compose:
    project_src: "{{ komodo_deployment_directory }}"
    state: present
    pull: true
