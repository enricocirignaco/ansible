#SPDX-License-Identifier: MIT-0
---
# tasks file for roles/komodo

- name: Validate required Komodo variables
  ansible.builtin.assert:
    that:
      - komodo_deployment_directory is defined and komodo_deployment_directory | length > 0
      - komodo_postgres_version is defined and komodo_postgres_version | length > 0
      - komodo_ferretdb_version is defined and komodo_ferretdb_version | length > 0
      - komodo_core_version is defined and komodo_core_version | length > 0
      - komodo_periphery_version is defined and komodo_periphery_version | length > 0
      - komodo_host_url is defined and komodo_host_url | length > 0
      - komodo_secret_db_username is defined and komodo_secret_db_username | length > 0
      - komodo_secret_db_password is defined and komodo_secret_db_password | length > 0
      - komodo_secret_passkey is defined and komodo_secret_passkey | length > 0
      - komodo_secret_webhook_secret is defined and komodo_secret_webhook_secret | length > 0
      - komodo_secret_jwt_secret is defined and komodo_secret_jwt_secret | length > 0
    fail_msg: "One or more required Komodo variables are undefined or empty. Set them via inventory or vault before running this role."
    quiet: true

- name: Ensure Komodo compose directory exists
  ansible.builtin.file:
    path: "{{ komodo_deployment_directory }}"
    state: directory
    mode: "0755"

- name: Ensure Komodo data directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0750"
  loop:
    - "{{ KOMODO_BACKUPS_PATH }}"
    - "{{ KOMODO_SYNCS_PATH }}"
    - "{{ PERIPHERY_PATH }}"
    - "{{ CERTIFICATES_PATH }}"
  loop_control:
    label: "{{ item }}"
  when: item is not none and item | length > 0

- name: Copy Komodo docker compose file
  ansible.builtin.copy:
    src: docker-compose.yaml
    dest: "{{ komodo_deployment_directory }}/docker-compose.yaml"
    owner: root
    group: root
    mode: "0640"

- name: Render Komodo environment file
  ansible.builtin.template:
    src: komodo.env.j2
    dest: "{{ komodo_deployment_directory }}/.env"
    owner: root
    group: root
    mode: "0600"

- name: Discover trusted certificates installed on host
  ansible.builtin.find:
    paths: /usr/local/share/ca-certificates
    patterns: "*.crt"
    recurse: true
    file_type: file
  register: komodo_trusted_certs
  become: true

- name: Copy trusted certificates into Komodo deployment
  ansible.builtin.copy:
    src: "{{ item.path }}"
    dest: "{{ CERTIFICATES_PATH }}/{{ item.path | basename }}"
    owner: root
    group: root
    mode: "0644"
    remote_src: true
  loop: "{{ komodo_trusted_certs.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  when: komodo_trusted_certs.matched | default(0) > 0
  become: true

- name: Ensure Komodo stack is running
  community.docker.docker_compose_v2:
    project_src: "{{ komodo_deployment_directory }}"
    state: present
    pull: always

- name: Refresh CA certificates inside Komodo core container
  ansible.builtin.command:
    argv:
      - docker
      - compose
      - "--project-directory"
      - "{{ komodo_deployment_directory }}"
      - exec
      - "-T"
      - core
      - update-ca-certificates
  become: true
  changed_when: true
  when: komodo_trusted_certs.matched | default(0) > 0
