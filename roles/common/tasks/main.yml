#SPDX-License-Identifier: MIT-0
---
# tasks file for roles/common

- name: Ensure timezone is set
  ansible.builtin.timezone:
    name: "{{ timezone }}"
  tags: [timezone, common]

- name: Optionally set hostname
  ansible.builtin.hostname:
    name: "{{ hostname }}"
  when: hostname is defined and hostname != ""
  tags: [hostname, common]

- name: Ensure system time sync service is enabled and running (systemd-timesyncd)
  ansible.builtin.systemd:
    name: systemd-timesyncd
    enabled: true
    state: started
  tags: [timesync, common]
- name: Ensure admin user ssh keys list is defined
  ansible.builtin.assert:
    that:
      - common_admin_authorized_keys is defined
      - common_admin_authorized_keys is iterable
    fail_msg: "common_admin_authorized_keys must be defined as a list of SSH public keys."

- name: Ensure admin user exists
  ansible.builtin.user:
    name: "{{ common_admin_user }}"
    shell: "{{ common_admin_shell }}"
    groups: "{{ common_admin_groups | join(',') if common_admin_groups | length > 0 else omit }}"
    append: true
    state: present
    create_home: true
  tags: [users, common]

- name: Ensure admin .ssh directory exists
  ansible.builtin.file:
    path: "/home/{{ common_admin_user }}/.ssh"
    state: directory
    owner: "{{ common_admin_user }}"
    group: "{{ common_admin_user }}"
    mode: "0700"
  tags: [users, common, ssh]

- name: Install admin authorized SSH keys
  ansible.builtin.authorized_key:
    user: "{{ common_admin_user }}"
    key: "{{ item }}"
    state: present
  loop: "{{ common_admin_authorized_keys }}"
  tags: [users, common, ssh]

- name: lock password (no password login yet)
  user:
    name: "{{ common_admin_user }}"
    password_lock: true
- name: remind operator to set password
  ansible.builtin.debug:
    msg: |
      The '{{ common_admin_user }}' user has been created.
      You can now log in using your SSH key:
        ssh {{ common_admin_user }}@{{ inventory_hostname }}
      Once logged in, run:
        sudo passwd {{ common_admin_user }}
      to set a personal password.
      
- name: Ensure cron is enabled and running
  ansible.builtin.systemd:
    name: cron
    enabled: true
    state: started
  tags: [cron, common]

- name: Perform packages upgrade
  ansible.builtin.apt:
    upgrade: yes
  tags: [upgrade, common]
- name: Ensure base packages are installed
  ansible.builtin.apt:
    name: "{{ common_base_packages }}"
    state: present
    update_cache: true
  tags: [packages, common]
- name: Autoremove unused packages
  ansible.builtin.apt:
    autoremove: true
  tags: [upgrade, common, clean]
- name: Autoclean apt cache
  ansible.builtin.apt:
    autoclean: true
  tags: [upgrade, common, clean]
