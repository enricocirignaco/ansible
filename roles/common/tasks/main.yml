#SPDX-License-Identifier: MIT-0
---
# tasks file for roles/common

- name: Ensure timezone is set
  ansible.builtin.timezone:
    name: "{{ timezone }}"
  tags: [timezone, common]

- name: Optionally set hostname
  ansible.builtin.hostname:
    name: "{{ hostname }}"
  when: hostname is defined and hostname != ""
  tags: [hostname, common]

- name: Ensure 127.0.1.1 maps to hostname
  ansible.builtin.blockinfile:
    path: /etc/hosts
    block: |
      127.0.0.1   localhost
      127.0.1.1   {{ hostname }}
    insertafter: BOF
    create: true
  when: hostname is defined and hostname != ""
  tags: [hostname, common]

- name: Ensure system time sync service is enabled and running (systemd-timesyncd)
  ansible.builtin.systemd:
    name: systemd-timesyncd
    enabled: true
    state: started
  tags: [timesync, common]

- name: Validate admin authorized keys list
  ansible.builtin.assert:
    that:
      - common_admin_authorized_keys is defined
      - common_admin_authorized_keys | length > 0
    fail_msg: "common_admin_authorized_keys must contain at least one SSH public key so the admin user can access the host."
  tags: [users, common, ssh]

- name: Ensure admin supplemental groups exist
  ansible.builtin.group:
    name: "{{ item }}"
    state: present
    system: true
  loop: "{{ common_admin_groups }}"
  when: common_admin_groups | length > 0
  tags: [users, common]

- name: Ensure admin user exists
  ansible.builtin.user:
    name: "{{ common_admin_user }}"
    shell: "{{ common_admin_shell }}"
    home: "{{ common_admin_home }}"
    groups: "{{ common_admin_groups | join(',') if common_admin_groups | length > 0 else omit }}"
    append: true
    state: present
    create_home: true
  tags: [users, common]

- name: Ensure admin .ssh directory exists
  ansible.builtin.file:
    path: "{{ common_admin_home }}/.ssh"
    state: directory
    owner: "{{ common_admin_user }}"
    group: "{{ common_admin_user }}"
    mode: "0700"
  when: common_admin_authorized_keys | length > 0
  tags: [users, common, ssh]

- name: Install admin authorized SSH keys
  ansible.builtin.authorized_key:
    user: "{{ common_admin_user }}"
    key: "{{ item }}"
    state: present
  loop: "{{ common_admin_authorized_keys }}"
  when: common_admin_authorized_keys | length > 0
  tags: [users, common, ssh]

- name: Remind operator to set admin password
  ansible.builtin.debug:
    msg: |
      '{{ common_admin_user }}' account is provisioned with SSH key access only.
      After first login run: sudo passwd {{ common_admin_user }}
  tags: [users, common]
  
- name: Ensure cron is enabled and running
  ansible.builtin.systemd:
    name: cron
    enabled: true
    state: started
  tags: [cron, common]

- name: Perform packages upgrade
  ansible.builtin.apt:
    upgrade: yes
  tags: [upgrade, common]
- name: Ensure base packages are installed
  ansible.builtin.apt:
    name: "{{ common_base_packages }}"
    state: present
    update_cache: true
  tags: [packages, common]
- name: Autoremove unused packages
  ansible.builtin.apt:
    autoremove: true
  tags: [upgrade, common, clean]
- name: Autoclean apt cache
  ansible.builtin.apt:
    autoclean: true
  tags: [upgrade, common, clean]

- name: Install Tailscale when requested
  ansible.builtin.shell: curl -fsSL https://tailscale.com/install.sh | sh
  args:
    creates: /usr/sbin/tailscaled
  when: common_install_tailscale | bool
  tags: [tailscale, common]

- name: Ensure tailscaled service is enabled and running
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started
  when: common_install_tailscale | bool
  tags: [tailscale, common]

- name: Ensure needed locales are generated
  community.general.locale_gen:
    name: "{{ locale }}"
    state: present
  loop: "{{ [common_system_locale, common_system_language | default('')] | reject('equalto', '') | list | unique }}"
  loop_control:
    loop_var: locale
    label: "{{ locale }}"
  tags: [locale, common]

- name: Set default system locale
  ansible.builtin.command: >
    update-locale LANG={{ common_system_language }} LC_CTYPE={{ common_system_locale }}
  changed_when: true

- name: Enable weekly Disk TRIM
  ansible.builtin.systemd:
    name: fstrim.timer
    enabled: true
    state: started
  tags: [trim, common]

- name: Ensure directory for trusted certificates exists
  ansible.builtin.file:
    path: /usr/local/share/ca-certificates/self-signed
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: [certificates, common]

- name: Install trusted certificates
  ansible.builtin.copy:
    src: root.crt
    dest: /usr/local/share/ca-certificates/self-signed/root.crt
    owner: root
    group: root
    mode: "0644"
  register: custom_ca_cert
  tags: [certificates, common]

- name: Update CA certificates
  ansible.builtin.command: update-ca-certificates
  when: custom_ca_cert is changed
  changed_when: true
  tags: [certificates, common]
