#SPDX-License-Identifier: MIT-0
---
# tasks file for roles/backup

- name: Ensure cifs/smb utilities are installed
  ansible.builtin.apt:
    name:
      - cifs-utils
    state: present
    update_cache: yes
  become: true
  tags: [backup, smb]

- name: Ensure SMB creds directory exists
  ansible.builtin.file:
    path: "{{ backup_smb_creds_file | dirname }}"
    state: directory
    owner: root
    group: root
    mode: "0700"
  become: true
  tags: [backup, smb]

- name: Write SMB credentials file
  ansible.builtin.copy:
    dest: "{{ backup_smb_creds_file }}"
    owner: root
    group: root
    mode: "0600"
    content: |
      username={{ backup_smb_username }}
      password={{ backup_smb_password }}
  become: true
  tags: [backup, smb]

- name: Ensure local mountpoint exists
  ansible.builtin.file:
    path: "{{ backup_smb_mountpoint }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true
  tags: [backup, mount]

- name: Ensure SMB share is mounted and persistent
  ansible.posix.mount:
    path: "{{ backup_smb_mountpoint }}"
    src: "//{{ backup_smb_share }}"
    fstype: cifs
    opts: "{{ backup_smb_mount_opts }}"
    state: mounted
  become: true
  tags: [backup, mount]


- name: Ensure snapshot dependencies are installed
  ansible.builtin.apt:
    name:
      - btrfs-progs
      - zstd
    state: present
    update_cache: yes
  become: true
  tags: [backup, snapshot]

- name: Ensure local snapshot directory exists
  ansible.builtin.file:
    path: "{{ backup_snapshot_local_path }}"
    state: directory
    owner: root
    group: root
    mode: "0750"
  become: true
  tags: [backup, snapshot]

- name: Ensure remote snapshot directory exists
  ansible.builtin.file:
    path: "{{ backup_snapshot_remote_path }}"
    state: directory
    owner: root
    group: root
    mode: "0750"
  become: true
  tags: [backup, snapshot]

- name: Ensure backup script directory exists
  ansible.builtin.file:
    path: "{{ backup_snapshot_script_path | dirname }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true
  tags: [backup, snapshot]

- name: Deploy snapshot script
  ansible.builtin.template:
    src: backup-snapshot.sh.j2
    dest: "{{ backup_snapshot_script_path }}"
    owner: root
    group: root
    mode: "0750"
  become: true
  tags: [backup, snapshot]

- name: Schedule daily backup snapshot
  ansible.builtin.cron:
    name: "Daily snapshot backup"
    user: "{{ backup_snapshot_cron_user }}"
    minute: "{{ backup_snapshot_cron_minute }}"
    hour: "{{ backup_snapshot_cron_hour }}"
    job: "{{ backup_snapshot_script_path }} >> {{ backup_snapshot_log_path }} 2>&1"
    state: present
  become: true
  tags: [backup, snapshot, cron]
