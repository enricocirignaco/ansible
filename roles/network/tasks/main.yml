#SPDX-License-Identifier: MIT-0
---

- name: Preflight | Ensure required variables are defined
  ansible.builtin.assert:
    that:
      - network_interface is defined and network_interface is string
      - network_method_v4 is defined
      - network_method_v4 in ['static', 'dhcp']

    fail_msg: >-
      Missing required variables. You must define network_interface and
      network_method_v4 ('static' or 'dhcp').
  tags: [network]

- name: Preflight | Ensure static IPv4 variables are defined
  ansible.builtin.assert:
    that:
      - "'/' in network_address"
      - (network_address | ansible.utils.ipaddr('address')) is ansible.utils.ipv4
      - network_gateway is defined and network_gateway is ansible.utils.ipv4
      - network_dns is defined and network_dns is iterable
      - network_dns | select('ansible.utils.ipv4') | list | length == (network_dns | length)

    fail_msg: >-
      Missing required variables for static IPv4 config. You must define
      network_address, network_gateway, and network_dns (list). Example:
      network_interface: eth0
      network_address: 192.168.1.157/24
      network_gateway: 192.168.1.1
      network_dns: ["192.168.1.1", "1.1.1.1"]
  when: network_method_v4 == 'static'
  tags: [network]

- name: Ensure arping tool is installed
  ansible.builtin.apt:
    name: iputils-arping
    state: present
    update_cache: false
  become: true
  tags: [network]

- name: Probe for duplicate IP on the LAN (ARP DAD)
  ansible.builtin.command: >
    arping -D -I {{ network_interface }} -c 2 -w 2 {{ network_address | ansible.utils.ipaddr('address') }}
  register: _arping
  changed_when: false
  failed_when: false
  become: true
  when: network_method_v4 == 'static'
  tags: [network]

- name: Abort if desired IP is already in use
  ansible.builtin.fail:
    msg: >
      IP {{ network_address | ansible.utils.ipaddr('address') }} appears to be in use on the local network
      (ARP replies seen). Aborting to prevent an address conflict.
      arping output: {{ _arping.stdout | default('') }} {{ _arping.stderr | default('') }}
  when:
    - network_method_v4 == 'static'
    - _arping.rc == 1
  tags: [network]

- name: Ensure NetworkManager is installed
  ansible.builtin.apt:
    name: network-manager
    state: present
    update_cache: true
  become: true
  tags: [network]

- name: Ensure NetworkManager service is enabled and running
  ansible.builtin.systemd:
    name: NetworkManager
    enabled: true
    state: started
  become: true
  tags: [network]

- name: Configure IPv4 connection with NetworkManager
  community.general.nmcli:
    conn_name: "{{ network_interface }}"
    ifname: "{{ network_interface }}"
    type: "{{ network_type }}"
    autoconnect: yes
    method4: "{{ 'manual' if network_method_v4 == 'static' else 'auto' }}"
    ip4: "{{ (network_method_v4 == 'static') | ternary(network_address, omit) }}"
    gw4: "{{ (network_method_v4 == 'static') | ternary(network_gateway, omit) }}"
    dns4: "{{ (network_method_v4 == 'static') | ternary(network_dns, omit) }}"
    state: present
  become: true
  register: nmcli_result
  tags: [network]

- name: Disable IPv6 on this connection
  community.general.nmcli:
    conn_name: "{{ network_interface }}"
    method6: ignore
    state: present
  become: true
  register: nmcli_ipv6_result
  tags: [network]
  when: network_disable_ipv6

- name: Activate Avahi (mDNS)
  ansible.builtin.systemd:
    name: avahi-daemon
    enabled: true
    state: started
    masked: false
  become: true
  register: avahi_result
  tags: [network, dns]

- name: Reboot system if needed
  ansible.builtin.shell: "nohup bash -c 'sleep 2 && /sbin/reboot' >/dev/null 2>&1 &"
  become: true
  async: 1
  poll: 0
  ignore_errors: true
  when:
    - network_reboot_if_changed
    - >
      (
        (nmcli_result is defined and nmcli_result.changed)
        or (nmcli_ipv6_result is defined and nmcli_ipv6_result.changed)
        or (avahi_result is defined and avahi_result.changed)
      )
  tags: [network, reboot]
