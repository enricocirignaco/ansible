---

# Example usage:
# ansible-playbook flash_os_on_ssd.yaml -i 'admin@bootstrap,' -e target_disk=/dev/nvme0n1 -e format_disk=true -e disable_power_management=true

- name: Prepare SSD and clone Raspberry Pi OS from SD
  hosts: all
  become: true
  vars:
    # Defaults
    boot_size_mb: 512
    root_size_gb: 28
    format_disk: false
    ansible_python_interpreter: /usr/bin/python3
    alignment_mib: 4
    disable_power_management: false

  pre_tasks:
    - name: Ensure Python 3 exists
      raw: test -e /usr/bin/python3 || (apt-get update -y && apt-get install -y python3)
      changed_when: false

    - name: Gather facts now that Python is present
      setup:

    - name: Check if target_disk was provided
      assert:
        that:
          - target_disk | default('', true) | length > 0
        fail_msg: |
          No target_disk was specified.
          
          Available disks on this Raspberry Pi:
          {% for dev in ansible_devices %}
            - {{ dev }}: {{ ansible_devices[dev].size }}
          {% endfor %}

          You must set target_disk, for example:
            -e target_disk=/dev/nvme0n1

    - name: Interactive user warning and confirmation
      debug:
        msg: |
          This playbook will prepare the target disk {{ target_disk }} and clone the Raspberry Pi OS installation from the SD card to the SSD.
          Current variable values:
            target_disk = {{ target_disk }}
            boot_size_mb = {{ boot_size_mb }}
            root_size_gb = {{ root_size_gb }}
            format_disk = {{ format_disk }}
          IMPORTANT:
            - If format_disk == true: ALL DATA on {{ target_disk }} WILL BE LOST (partition table + all partitions will be recreated).
            - If format_disk == false: Existing partitions are kept, but partitions 1 and 2 will be overwritten by rpi-clone.

    - pause:
        prompt: "Type 'yes' to continue, or anything else to abort"
      register: user_confirm
    - name: Abort if user did not confirm
      fail:
        msg: "User aborted the playbook."
      when: user_confirm.user_input != 'yes'

  tasks:
  # Download and install rpi-clone
    - name: Ensure git is installed
      apt:
        name: git
        state: present
        update_cache: yes

    - name: Check if rpi-clone is already installed
      stat:
        path: /usr/local/sbin/rpi-clone
      register: rpi_clone_bin

    - name: Clone rpi-clone repo
      git:
        repo: "https://github.com/geerlingguy/rpi-clone.git"
        dest: /tmp/rpi-clone
        version: HEAD
      when: not rpi_clone_bin.stat.exists

    - name: Install rpi-clone binary
      copy:
        src: /tmp/rpi-clone/rpi-clone
        dest: /usr/local/sbin/rpi-clone
        owner: root
        group: root
        mode: "0755"
        remote_src: yes
      when: not rpi_clone_bin.stat.exists

    # Optionally disable NVME and PCIe power management to avoid issues with some SSDs
    - name: Check cmdline.txt location
      stat:
        path: /boot/firmware/cmdline.txt
      register: cmdline_firmware
      when: disable_power_management | bool

    - name: Disable NVME and PCIe power management
      ansible.builtin.lineinfile:
        path: "{{ cmdline_firmware.stat.exists | default(false) | ternary('/boot/firmware/cmdline.txt', '/boot/cmdline.txt') }}"
        regexp: '^(?!.*pcie_aspm=off)(.*)$'
        line: '\\1 pcie_aspm=off nvme_core.default_ps_max_latency_us=0'
        backrefs: true
      when: disable_power_management | bool

    # Prepare target disk
    - name: Create new msdos partition table on target disk (will erase all partitions)
      command: "parted -s {{ target_disk }} mklabel msdos"
      when: format_disk | bool

    - name: Create boot partition (p1)
      parted:
        device: "{{ target_disk }}"
        number: 1
        state: present
        part_start: "{{ alignment_mib | int }}MiB"
        part_end:   "{{ (alignment_mib | int) + (boot_size_mb | int) }}MiB"
        fs_type: fat32
      when: format_disk | bool

    - name: Create root partition (p2)
      parted:
        device: "{{ target_disk }}"
        number: 2
        state: present
        part_start: "{{ (alignment_mib | int) + (boot_size_mb | int) }}MiB"
        part_end:   "{{ (alignment_mib | int)
                       + (boot_size_mb | int)
                       + ((root_size_gb | int) * 1024) }}MiB"
        fs_type: ext4
      when: format_disk | bool

    - name: Create data partition (p3)
      parted:
        device: "{{ target_disk }}"
        number: 3
        state: present
        part_start: "{{ (alignment_mib | int)
                       + (boot_size_mb | int)
                       + ((root_size_gb | int) * 1024) }}MiB"
        part_end: "100%"
        fs_type: ext4
      when: format_disk | bool

    - name: Create FAT32 filesystem on boot partition (p1)
      filesystem:
        fstype: vfat
        dev: "{{ target_disk }}p1"
      when: format_disk | bool

    - name: Create ext4 filesystem on root partition (p2)
      filesystem:
        fstype: ext4
        dev: "{{ target_disk }}p2"
      when: format_disk | bool

    - name: Create ext4 filesystem on data partition (p3)
      filesystem:
        fstype: ext4
        dev: "{{ target_disk }}p3"
      when: format_disk | bool

    - name: Refresh partition table
      command: "partprobe {{ target_disk }}"
      changed_when: false

    # Setup boot order (NVMe/SSD first with SD as fallback)
    - name: Ensure raspi-config is installed
      apt:
        name: raspi-config
        state: present
        update_cache: yes

    - name: Set boot order
      command: raspi-config nonint do_boot_order B2
      
    # Dry-run rpi-clone to show what would be done, then ask for confirmation
    - name: Dry-run rpi-clone (auto-answer "no" to see the summary)
      shell: |
        echo no | sudo rpi-clone {{ target_disk }} || true
      args:
        executable: /bin/bash
      environment:
        LC_ALL: C
      register: rpi_clone_dry
      changed_when: false
      failed_when: false

    - name: Show rpi-clone dry-run output
      debug:
        msg: "rpi-clone dry run: {{ rpi_clone_dry.stdout }}"

    - name: Ask whether to actually run rpi-clone now
      pause:
        prompt: |
          Above is the output of:
            sudo rpi-clone {{ target_disk }}

          Type 'yes' to actually run the clone now
      register: clone_confirm

    - name: Run rpi-clone (auto-answer "yes")
      shell: |
        yes | sudo rpi-clone {{ target_disk }}
      args:
        executable: /bin/bash
      environment:
        LC_ALL: C
      when: clone_confirm.user_input == 'yes'
      register: rpi_clone_result

    - name: Reboot system to use SSD as boot device
      reboot:
        msg: "Rebooting to use SSD as boot device"
        pre_reboot_delay: 5
        reboot_timeout: 300
        post_reboot_delay: 10
      when:
        - rpi_clone_result is defined
        - rpi_clone_result.rc == 0
