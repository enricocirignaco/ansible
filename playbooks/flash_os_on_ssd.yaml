---

# Example usage:
# ansible-playbook flash_os_on_ssd.yaml \
#   -e target_disk=/dev/nvme0n1 \
#   -e format_disk=true

- name: Prepare SSD and clone Raspberry Pi OS from SD
  hosts: rpi
  become: true
  vars:
    # Defaults
    boot_size_mb: 256
    root_size_gb: 28
    format_disk: false
  
  pre_tasks:
    - name: Ensure Python 3 exists
      raw: test -e /usr/bin/python3 || (apt-get update -y && apt-get install -y python3)
      changed_when: false

    - name: Gather facts now that Python is present
      setup:

    - name: Ensure target_disk is provided
      assert:
        that:
          - target_disk | default('', true) | length > 0
        fail_msg: "You must set target_disk (e.g. -e target_disk=/dev/nvme0n1) before running this playbook."

    - name: Interactive user warning and confirmation
      debug:
        msg: |
          This playbook will prepare the target disk {{ target_disk }} and clone the Raspberry Pi OS installation from the SD card to the SSD.
          Current variable values:
            target_disk = {{ target_disk }}
            boot_size_mb = {{ boot_size_mb }}
            root_size_gb = {{ root_size_gb }}
            format_disk = {{ format_disk }}
          IMPORTANT:
            - If format_disk == true: ALL DATA on {{ target_disk }} WILL BE LOST (partition table + all partitions will be recreated).
            - If format_disk == false: Existing partitions are kept, but partitions 1 and 2 will be overwritten by rpi-clone.

    - pause:
        prompt: "Press Enter to continue, or Ctrl+C then 'A' to abort"

  tasks:
  # Download and install rpi-clone
    - name: Ensure git is installed
      apt:
        name: git
        state: present
        update_cache: yes

    - name: Check if rpi-clone is already installed
      stat:
        path: /usr/local/sbin/rpi-clone
      register: rpi_clone_bin

    - name: Clone rpi-clone repo
      git:
        repo: "https://github.com/jeffgeerling/rpi-clone.git"
        dest: /tmp/rpi-clone
        version: HEAD
      when: not rpi_clone_bin.stat.exists

    - name: Install rpi-clone binary
      copy:
        src: /tmp/rpi-clone/rpi-clone
        dest: /usr/local/sbin/rpi-clone
        owner: root
        group: root
        mode: "0755"
      when: not rpi_clone_bin.stat.exists

    # Partition target disk
    - name: Create MBR partition table on target disk (will erase all data)
      parted:
        device: "{{ target_disk }}"
        label: msdos
        state: present
      when: format_disk is true

    - name: Create boot partition (p1)
      parted:
        device: "{{ target_disk }}"
        number: 1
        state: present
        part_start: 1MiB
        part_end: "{{ boot_size_mb }}MiB"
        fs_type: fat32
      when: format_disk is true

    - name: Create root partition (p2)
      parted:
        device: "{{ target_disk }}"
        number: 2
        state: present
        part_start: "{{ boot_size_mb }}MiB"
        part_end: "{{ (boot_size_mb / 1024.0) + root_size_gb }}GiB"
        fs_type: ext4
      when: format_disk is true

    - name: Create data partition (p3) if specified
      parted:
        device: "{{ target_disk }}"
        number: 3
        state: present
        part_start: "{{ (boot_size_mb / 1024.0) + root_size_gb }}GiB"
        part_end: "100%"
        fs_type: ext4
      when:
        - format_disk is true

    - name: Refresh partition table
      command: "partprobe {{ target_disk }}"
      changed_when: false

    # Setup boot order (NVMe/SSD first with SD as fallback)
    - name: Ensure raspi-config is installed
      apt:
        name: raspi-config
        state: present
        update_cache: yes

    - name: Set boot order
      command: raspi-config nonint do_boot_order B2

    # Clone from SD to SSD
    - name: Clone boot and root to target disk (overwrite partitions 1 and 2)
      shell: yes | /usr/local/sbin/rpi-clone -p 1,2 {{ target_disk }}
      args:
        executable: /bin/bash
      environment:
        LC_ALL: C

    - name: Refresh partition table after cloning
      command: "partprobe {{ target_disk }}"
